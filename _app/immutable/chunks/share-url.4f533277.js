import{g as h,h as A}from"./connection.d00f3c10.js";function m(t){let e=new Uint8Array(5);const n=new DataView(e.buffer);if(n.setUint32(0,t.length),t.length===0)return e;if(typeof t[0]=="number"){n.setUint8(4,i.indexOf("number"));const r=A(t);return n.setUint32(0,r.length),u(e,r)}else{if(Array.isArray(t[0]))return n.setUint8(4,i.indexOf("array")),u(e,...t.map(m));throw new Error("Not implemented")}}function y(t,e={pos:0}){const n=new DataView(t.buffer),r=n.getUint32(e.pos);e.pos+=4;const s=i[n.getUint8(e.pos)];if(e.pos++,s==="number"){const o=h(t.slice(e.pos,e.pos+r));return e.pos+=r,o}else if(s==="array"){const o=[];for(let a=0;a<r;a++)o.push(y(t,e));return o}else throw new Error("Not implemented")}function u(...t){const e=new Uint8Array(t.reduce((r,s)=>r+s.length,0));let n=0;for(const r of t)e.set(r,n),n+=r.length;return e}async function g(t){return new Promise(async e=>{const n=new FileReader;n.onloadend=function(){e(`${n.result.replace(/^data:application\/octet-stream;base64,/,"").replaceAll("+",".").replaceAll("/","_").replaceAll("=","-")}`)},n.readAsDataURL(t)})}async function b(t,e=window.fetch){return e(`data:application/octet-stream;base64,${t.replaceAll(".","+").replaceAll("_","/").replaceAll("-","=")}`).then(n=>n.blob())}const w={layout:[["layout","array"],["device","string"]],chords:[["chords","array"]],settings:[["settings","array"]]},i=["unknown","number","string","array"],c=`
`;async function v(t){let e=`${t.type}${c}${t.charaVersion}`;for(const[n,r]of w[t.type]){const s=t[n];if(e+=c,r==="string")e+=s;else if(r==="array"){const o=new Blob([m(s)]).stream().pipeThrough(new CompressionStream("deflate"));e+=await g(await new Response(o).blob())}else throw new Error("Not implemented")}return e}async function E(t,e=window.fetch){const[n,r,...s]=t.split(c),o={type:n,charaVersion:Number(r)};for(const[a,l]of w[n]){const p=s.shift();if(l==="string")o[a]=p;else if(l==="array"){const d=(await b(p,e)).stream().pipeThrough(new DecompressionStream("deflate")),f=new Uint8Array(await new Response(d).arrayBuffer());console.log(f),o[a]=y(f)}}return o}export{v as a,E as c};
//# sourceMappingURL=share-url.4f533277.js.map
